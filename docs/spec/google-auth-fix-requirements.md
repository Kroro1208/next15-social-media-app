# Google認証修復 要件定義書

## 概要

投票・議論プラットフォームのデプロイ後に発生している Google OAuth認証でno_codeエラーが発生し、ユーザーがログインできない問題を解決する。本番環境でOAuthフローが失敗し、認証コードが取得できない状態となっている。

## 問題の現状

- **発生環境**: 本番環境（Vercel）
- **エラーURL**: `https://social-media-app-jade-three.vercel.app/auth/login?error=no_code`
- **エラー内容**: 認証コードが見つかりません（デバッグ情報: no_code）
- **影響範囲**: ユーザーがログインできないため、アプリケーションの基本機能すべてが利用不可
- **優先度**: 最高（緊急） - サービス停止状態

## ユーザストーリー

### ストーリー1: 基本認証機能の復旧

- **である** エンドユーザー **として**
- **私は** Google アカウントでログインしたい
- **そうすることで** 投票・議論プラットフォームの全機能を利用できる

### ストーリー2: 認証エラーの解決

- **である** システム管理者 **として**
- **私は** OAuth認証フローの問題を特定し修正したい
- **そうすることで** ユーザーの認証エラーを解消し、サービスを復旧できる

### ストーリー3: 本番環境での安定動作

- **である** 開発者 **として**
- **私は** 本番環境でローカル環境と同様に認証が動作することを確認したい
- **そうすることで** 環境差異による認証問題を防止できる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムは Google OAuth2.0認証フローを正常に処理しなければならない
- REQ-002: システムは認証コールバックで authorization code を正常に受信しなければならない
- REQ-003: システムは受信した authorization code を有効なセッショントークンに交換しなければならない
- REQ-004: システムは認証成功後にユーザーをホーム画面（/）にリダイレクトしなければならない
- REQ-005: システムは認証状態をクライアント・サーバー間で一貫して管理しなければならない

### 条件付き要件

- REQ-101: 認証コールバックでcodeパラメータが存在しない場合、システムは詳細なデバッグ情報と共にエラーページにリダイレクトしなければならない
- REQ-102: OAuth プロバイダからエラーパラメータが返される場合、システムは適切なエラーメッセージを表示しなければならない
- REQ-103: セッション作成に失敗した場合、システムは具体的なエラー理由をログに記録しなければならない
- REQ-104: 本番環境とローカル環境で異なる動作が発生する場合、システムは環境固有の設定を適切に処理しなければならない

### 状態要件

- REQ-201: 未認証状態にある場合、システムはログインページを表示しなければならない
- REQ-202: 認証処理中の状態にある場合、システムは適切なローディング状態を表示しなければならない
- REQ-203: 認証エラー状態にある場合、システムは具体的なエラー内容と解決方法を表示しなければならない

### オプション要件

- REQ-301: システムは認証失敗の詳細ログを管理者ダッシュボードで確認できてもよい
- REQ-302: システムは認証問題の自動検知と通知機能を提供してもよい

### 制約要件

- REQ-401: システムは Supabase Auth の仕様に準拠して認証処理を実装しなければならない
- REQ-402: システムは Google Cloud Console で設定されたリダイレクトURLを厳密に遵守しなければならない
- REQ-403: システムは Next.js App Router の制約に準拠したコールバック処理を実装しなければならない
- REQ-404: システムは PKCE（Proof Key for Code Exchange）フローに対応しなければならない

## 非機能要件

### パフォーマンス

- NFR-001: 認証処理は5秒以内に完了しなければならない
- NFR-002: 認証エラー発生時のレスポンス時間は3秒以内でなければならない

### セキュリティ

- NFR-101: 認証コードやセッション情報はログに出力してはならない
- NFR-102: CSRF攻撃を防止するための適切な検証を実装しなければならない
- NFR-103: HTTPSを強制し、セキュアな通信を確保しなければならない

### 可用性

- NFR-201: 認証サービスの可用性は99.9%以上でなければならない
- NFR-202: 認証失敗時も適切なエラー画面を表示し、サービス全体の停止を防がなければならない

### ユーザビリティ

- NFR-301: 認証エラー時は分かりやすいエラーメッセージを日本語で表示しなければならない
- NFR-302: 認証処理中はローディング状態を視覚的に示さなければならない

## 技術的調査項目

### 環境設定検証

- TECH-001: Google Cloud Console のOAuth設定とリダイレクトURLの整合性確認
- TECH-002: Supabase Dashboard の認証設定とGoogle OAuth設定の確認
- TECH-003: Vercel環境変数の設定値確認（NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY）
- TECH-004: 本番環境とローカル環境の設定差異の特定

### 認証フロー分析

- TECH-101: OAuth2.0認証フローの各ステップでのリクエスト・レスポンス検証
- TECH-102: 認証コールバックURL（/auth/callback）の動作確認
- TECH-103: Supabase Auth の signInWithOAuth() 処理の検証
- TECH-104: Next.js App Router でのリダイレクト処理の確認

### デバッグ情報収集

- TECH-201: ブラウザ開発者ツールでのネットワークリクエスト分析
- TECH-202: Vercel Function Logs での詳細ログ確認
- TECH-203: Supabase Auth Logs での認証試行履歴確認

## Edgeケース

### 認証フローエラー

- EDGE-001: Google OAuth プロバイダからの拒否レスポンス処理
- EDGE-002: 期限切れ認証コードの処理
- EDGE-003: 無効な認証コードの処理
- EDGE-004: ネットワーク障害時の認証失敗処理

### 環境固有問題

- EDGE-101: Vercel のサーバーレス関数制約による認証処理
- EDGE-102: CDN キャッシュによる認証状態の不整合
- EDGE-103: 複数地域展開時のセッション同期問題

### セキュリティ関連

- EDGE-201: CSRF攻撃による不正な認証試行
- EDGE-202: セッションハイジャック攻撃の検知と防止
- EDGE-203: 認証情報の不正な露出や漏洩

## 受け入れ基準

### 機能テスト

- [ ] Google アカウントでのログインが正常に完了する
- [ ] 認証成功後にホーム画面（/）にリダイレクトされる
- [ ] 認証失敗時に適切なエラーメッセージが表示される
- [ ] 本番環境とローカル環境で同一の認証動作をする
- [ ] 複数ブラウザ・デバイスでの認証動作確認
- [ ] 認証状態の永続化と復旧が正常に動作する

### 非機能テスト

- [ ] 認証処理時間が5秒以内で完了する
- [ ] 同時認証処理（100ユーザー）に対応できる
- [ ] 認証エラー発生時もシステム全体が安定している
- [ ] セキュリティ脆弱性スキャンに合格する

### 統合テスト

- [ ] Supabase Auth との連携が正常に動作する
- [ ] Google OAuth2.0 API との連携が正常に動作する
- [ ] Next.js App Router での認証フローが正常に動作する
- [ ] Vercel本番環境での認証動作が確認される

### 回帰テスト

- [ ] 既存の投票・コメント機能が認証修正後も正常に動作する
- [ ] 通知システムが認証修正後も正常に動作する
- [ ] 管理機能が認証修正後も正常に動作する

## 実装優先度

### P0（緊急）- 即座対応必要

1. 認証コールバック処理の修正（REQ-001, REQ-002, REQ-003）
2. エラーハンドリングの改善（REQ-101, REQ-102, REQ-103）

### P1（高優先度）- 1週間以内

3. 環境固有問題の解決（REQ-104, TECH-003, TECH-004）
4. 詳細ログと監視の実装（REQ-301, TECH-201, TECH-202）

### P2（中優先度）- 2週間以内

5. ユーザビリティ改善（NFR-301, NFR-302）
6. セキュリティ強化（NFR-101, NFR-102, NFR-103）

## 成功指標

### 定量的指標

- 認証成功率: 99%以上
- 認証処理時間: 平均3秒以下
- エラー解決時間: 2営業日以内
- ユーザーの認証失敗率: 1%以下

### 定性的指標

- ユーザーからの認証関連の問い合わせがゼロ
- 本番環境でのサービス安定稼働
- 開発チームの認証問題への対応自信度向上
- 将来の認証機能拡張の基盤確立

---

**作成日**: 2025-08-23
**優先度**: 最高（緊急対応）
**想定工数**: 40-60時間
**担当**: システム認証チーム
**レビュー**: プロダクトマネージャー、セキュリティエンジニア
