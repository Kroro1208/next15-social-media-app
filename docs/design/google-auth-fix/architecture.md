# Google認証修復 アーキテクチャ設計

## システム概要

投票・議論プラットフォームにおけるGoogle OAuth認証の修復を目的とした設計。現在発生している`no_code`エラーを解決し、本番環境（Vercel）での安定した認証フローを実現する。

## 現在のアーキテクチャ分析

### 技術スタック
- **フロントエンド**: Next.js 15.4.4 + React 19.1.1 + TypeScript 5.7.2
- **認証基盤**: Supabase Auth + Google OAuth 2.0
- **デプロイ環境**: Vercel (サーバーレス)
- **状態管理**: Jotai + TanStack React Query

### 現在の認証フロー
```
User → Google OAuth → Callback (/auth/callback) → Supabase Auth → Session → Home (/)
                ↓ (問題発生)
            no_code error
```

## 問題の根本原因分析

### 特定された問題点

1. **環境固有の設定不整合**
   - 本番環境とローカル環境の動作差異
   - Vercelサーバーレス環境での制約

2. **OAuth フロー中断**
   - 認証コード (authorization code) の未受信
   - Google OAuth プロバイダからのレスポンス不整合

3. **コールバック処理の不備**
   - エラーハンドリングの不十分
   - デバッグ情報の不足

## 修復アーキテクチャ設計

### アーキテクチャパターン
- **パターン**: OAuth 2.0 Authorization Code Flow with PKCE
- **理由**: セキュリティ強化とSPA環境での推奨実装
- **実装方式**: Supabase Auth SDK による統一管理

### コンポーネント構成

#### フロントエンド層
```
┌─────────────────────────────────────────┐
│          フロントエンド (Next.js)        │
├─────────────────────────────────────────┤
│ LoginPage.tsx                           │
│ ├─ Google認証ボタン                     │
│ ├─ エラー表示                           │
│ └─ ローディング状態                     │
├─────────────────────────────────────────┤
│ AuthContext.tsx                         │
│ ├─ 認証状態管理                         │
│ ├─ セッション監視                       │
│ └─ エラーハンドリング                   │
└─────────────────────────────────────────┘
```

#### API層（App Router）
```
┌─────────────────────────────────────────┐
│        API Layer (App Router)          │
├─────────────────────────────────────────┤
│ /auth/callback/route.ts                 │
│ ├─ 認証コード検証                       │
│ ├─ Supabase セッション交換              │
│ ├─ エラーハンドリング強化               │
│ └─ 詳細ログ出力                         │
├─────────────────────────────────────────┤
│ /auth/login/route.ts (新規)             │
│ ├─ 認証開始処理                         │
│ ├─ 環境設定検証                         │
│ └─ デバッグ情報収集                     │
└─────────────────────────────────────────┘
```

#### 認証基盤
```
┌─────────────────────────────────────────┐
│         Supabase Auth Layer            │
├─────────────────────────────────────────┤
│ Google OAuth Provider                   │
│ ├─ PKCE フロー対応                     │
│ ├─ セッション管理                       │
│ └─ トークン更新                         │
├─────────────────────────────────────────┤
│ Row Level Security                      │
│ ├─ ユーザー権限管理                     │
│ └─ データアクセス制御                   │
└─────────────────────────────────────────┘
```

#### インフラ・モニタリング層
```
┌─────────────────────────────────────────┐
│      Infrastructure & Monitoring       │
├─────────────────────────────────────────┤
│ Vercel Functions                        │
│ ├─ エッジランタイム最適化               │
│ ├─ 環境変数管理                         │
│ └─ リージョン設定                       │
├─────────────────────────────────────────┤
│ Logging & Analytics                     │
│ ├─ Vercel Analytics                     │
│ ├─ Supabase Auth Logs                   │
│ └─ カスタムエラートラッキング           │
└─────────────────────────────────────────┘
```

## セキュリティ設計

### 認証セキュリティ
- **PKCE実装**: Code Verifier/Challenge による認証強化
- **CSRF対策**: State パラメータによる検証
- **セッション保護**: Secure Cookie + HttpOnly フラグ
- **リダイレクト検証**: 許可されたリダイレクトURLの厳格チェック

### データ保護
- **機密情報の非ログ出力**: 認証コード・トークンの保護
- **HTTPS強制**: 全通信の暗号化
- **環境変数の適切な管理**: Vercel Environment Variables活用

## パフォーマンス設計

### レスポンス時間最適化
- **認証処理**: 5秒以内完了目標
- **エラー処理**: 3秒以内レスポンス
- **キャッシュ戦略**: 認証状態の効率的管理

### スケーラビリティ
- **サーバーレス対応**: Vercel Functions の制約考慮
- **同時接続**: 100ユーザー同時認証対応
- **地域対応**: エッジデプロイメント活用

## 可用性・信頼性設計

### エラー回復
- **自動リトライ**: ネットワークエラー時の再試行
- **グレースフルデグラデーション**: 部分的な機能停止時の対応
- **フォールバック**: 代替認証手段の提供

### モニタリング
- **ヘルスチェック**: 認証サービス生存監視
- **アラート**: 認証失敗率の閾値監視
- **ダッシュボード**: リアルタイム認証状況表示

## 技術的制約と対策

### Vercel制約への対応
```typescript
// サーバーレス関数の最適化
export const runtime = 'edge'; // エッジランタイム活用
export const dynamic = 'force-dynamic'; // 動的処理の明示
```

### Next.js App Router対応
```typescript
// App Router のリダイレクト処理
import { NextResponse } from 'next/server';
return NextResponse.redirect(new URL('/', request.url));
```

### 環境差異の解決
```typescript
// 環境に応じた設定分岐
const redirectUrl = process.env.NODE_ENV === 'production'
  ? process.env.NEXT_PUBLIC_SITE_URL
  : 'http://localhost:3000';
```

## 実装戦略

### フェーズド・アプローチ
1. **Phase 1**: 緊急修復（コールバック処理とエラーハンドリング）
2. **Phase 2**: 監視・ログ強化
3. **Phase 3**: UX改善とセキュリティ強化

### リスク軽減
- **段階的デプロイ**: 機能フラグによる制御
- **A/Bテスト**: 新旧実装の比較検証
- **ロールバック計画**: 問題発生時の即座復旧

---

**設計責任者**: システムアーキテクト
**レビュー対象**: セキュリティチーム、インフラチーム
**更新日**: 2025-08-23